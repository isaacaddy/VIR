<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Registration Records</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .logo {
            width: 130px;
            height: 75px;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .logo:hover {
            transform: scale(1.1);
        }

        /* Modal styles */
        .modal {
            display: none;
            transition: all 0.3s ease-in-out;
        }

        .modal.show {
            display: block !important;
        }

        .modal .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        /* Enhanced modal content styling */
        #viewModal .bg-gray-50 {
            background-color: #f9fafb;
        }

        #viewModal p {
            word-wrap: break-word;
            min-height: 1.25rem;
        }

        /* Scrollbar styling for modal */
        #viewModal .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        #viewModal .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #viewModal .modal-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #viewModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Status badges */
        .status-active {
            background-color: #10b981;
            color: white;
        }

        .status-pending {
            background-color: #f59e0b;
            color: white;
        }

        .status-expired {
            background-color: #ef4444;
            color: white;
        }

        /* Table hover effects */
        tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Loading spinner */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #16a34a;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Simple table horizontal scrolling */
        #tableContainer {
            overflow-x: auto;
        }

        #tableContainer table {
            width: 100%;
            min-width: 1200px;
        }

        #tableContainer th,
        #tableContainer td {
            white-space: nowrap;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen flex items-center justify-center">
    <div class="flex min-h-screen w-full">
        <!-- Sidebar -->
        <div class="w-64 min-w-64 bg-gradient-to-b from-green-700 to-teal-600 p-6 text-white shadow-lg flex flex-col">
            <div>
                <div class="flex items-center mb-8">
                    <a href="dashboard.html">
                        <img src="./images/oop.png" alt="DVLA Logo" class="logo cursor-pointer">
                    </a>
                    <div class="ml-3">
                        <h2 class="text-2xl font-bold">DVLA</h2>
                        <p class="text-sm opacity-75">Vehicle Inspection and Registration</p>
                    </div>
                </div>
                <nav>
                    <a href="dashboard.html"
                        class="flex items-center p-3 mb-2 hover:bg-green-500 rounded-lg transition duration-200">
                        <span class="material-icons mr-3">dashboard</span>
                        <span>Dashboard</span>
                    </a>
                    <div class="relative">
                        <button onclick="toggleVehicleDropdown()"
                            class="flex items-center justify-between w-full p-3 mb-2 bg-green-600 rounded-lg hover:bg-green-500 transition duration-200">
                            <div class="flex items-center">
                                <span class="material-icons mr-3">directions_car</span>
                                <span>Vehicle Register</span>
                            </div>
                            <span class="material-icons" id="vehicleDropdownIcon">expand_less</span>
                        </button>
                        <div id="vehicleDropdown" class="ml-6 mt-1 space-y-1">
                            <a href="VehicleRegistration.html"
                                class="flex items-center p-2 text-sm hover:bg-green-600 rounded-lg transition duration-200">
                                <span class="material-icons mr-2 text-sm">add</span>
                                <span>Register Vehicle</span>
                            </a>
                            <a href="VehicleRegistrationRecords.html"
                                class="flex items-center p-2 text-sm bg-green-700 rounded-lg hover:bg-green-600 transition duration-200">
                                <span class="material-icons mr-2 text-sm">list_alt</span>
                                <span>View Records</span>
                            </a>
                            <a href="VehicleRegisterHistory.html"
                                class="flex items-center p-2 text-sm hover:bg-green-600 rounded-lg transition duration-200">
                                <span class="material-icons mr-2 text-sm">history</span>
                                <span>History</span>
                            </a>
                        </div>
                    </div>
                    <div class="relative">
                        <button onclick="toggleOwnershipDropdown()"
                            class="flex items-center justify-between w-full p-3 mb-2 hover:bg-green-500 rounded-lg transition duration-200">
                            <div class="flex items-center">
                                <span class="material-icons mr-3">sync_alt</span>
                                <span>Ownership</span>
                            </div>
                            <span class="material-icons" id="ownershipDropdownIcon">expand_more</span>
                        </button>
                        <div id="ownershipDropdown" class="hidden ml-6 mt-1 space-y-1">
                            <a href="changeowner.html"
                                class="flex items-center p-2 text-sm hover:bg-green-600 rounded-lg transition duration-200">
                                <span class="material-icons mr-2 text-sm">edit</span>
                                <span>Transfer Ownership</span>
                            </a>
                            <a href="records.html"
                                class="flex items-center p-2 text-sm hover:bg-green-600 rounded-lg transition duration-200">
                                <span class="material-icons mr-2 text-sm">search</span>
                                <span>Search Records</span>
                            </a>
                        </div>
                    </div>
                    <a href="admin.html"
                        class="flex items-center p-3 mb-2 hover:bg-green-500 rounded-lg transition duration-200">
                        <span class="material-icons mr-3">admin_panel_settings</span>
                        <span>Admin</span>
                    </a>
                </nav>
            </div>
            <div class="mt-auto flex flex-col items-center">
                <button onclick="handleLogout()"
                    class="flex items-center bg-gradient-to-r from-green-600 to-teal-600 text-white px-5 py-3 rounded-lg shadow-lg hover:from-green-500 hover:to-teal-500 transform hover:scale-105 transition duration-200 ease-in-out mb-4">
                    <span class="material-icons mr-2">logout</span>
                    <span class="font-semibold">Logout</span>
                </button>
                <div class="text-center opacity-75 text-sm">
                    Â© 2024 DVLA Club
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Vehicle Registration Records</h1>
                        <p class="text-gray-600">Manage and view all registered vehicles</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="window.location.href='VehicleRegistration.html'"
                            class="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                            <span class="material-icons mr-2">add</span>
                            Register New Vehicle
                        </button>
                        <button onclick="exportRecords()"
                            class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                            <span class="material-icons mr-2">download</span>
                            Export to Excel
                        </button>

                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="space-y-4">
                    <!-- First Row: Search and Basic Filters -->
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-64">
                            <input type="text" id="searchInput"
                                placeholder="Search by vehicle number, chassis, or owner name..."
                                class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" />
                        </div>
                        <div>
                            <select id="statusFilter"
                                class="border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>
                        <div>
                            <select id="yearFilter"
                                class="border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">All Years</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                            </select>
                        </div>
                    </div>

                    <!-- Second Row: Date Range and Action Buttons -->
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">Registration Date:</span>
                            <div class="flex items-center space-x-2">
                                <input type="date" id="startDate"
                                    class="border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"
                                    title="Start Date" />
                                <span class="text-gray-500">to</span>
                                <input type="date" id="endDate"
                                    class="border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"
                                    title="End Date" />
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="setDateRange('today')"
                                class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition duration-200 text-sm">
                                Today
                            </button>
                            <button onclick="setDateRange('week')"
                                class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition duration-200 text-sm">
                                This Week
                            </button>
                            <button onclick="setDateRange('month')"
                                class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition duration-200 text-sm">
                                This Month
                            </button>
                            <button onclick="setDateRange('year')"
                                class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition duration-200 text-sm">
                                This Year
                            </button>
                        </div>
                        <div class="flex items-center space-x-2 ml-auto">
                            <button onclick="searchRecords()"
                                class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-200 flex items-center">
                                <span class="material-icons mr-2">search</span>
                                Search
                            </button>
                            <button onclick="clearFilters()"
                                class="bg-gray-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-200 flex items-center">
                                <span class="material-icons mr-2">clear</span>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Registered</p>
                            <p class="text-2xl font-bold text-gray-800" id="totalRegistered">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="material-icons text-green-600">directions_car</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Today</p>
                            <p class="text-2xl font-bold text-green-600" id="todayCount">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="material-icons text-green-600">today</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">This Week</p>
                            <p class="text-2xl font-bold text-blue-600" id="weekCount">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="material-icons text-blue-600">date_range</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">This Month</p>
                            <p class="text-2xl font-bold text-purple-600" id="monthlyCount">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <span class="material-icons text-purple-600">calendar_today</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Deleted</p>
                            <p class="text-2xl font-bold text-red-600" id="deletedCount">0</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <span class="material-icons text-red-600">delete</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Table -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Registration Records</h2>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="flex justify-center items-center p-8">
                    <div class="loading-spinner"></div>
                    <span class="ml-3 text-gray-600">Loading records...</span>
                </div>

                <!-- Table -->
                <div id="tableContainer" class="hidden overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Registration No.</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Name</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Address</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Chassis</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Make</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Model</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Year</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Cubic Capacity</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    No. of Cylinders</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Declaration No.</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Use</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Remarks</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Timestamp</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Records will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12">
                    <span class="material-icons text-gray-400 text-6xl mb-4">directions_car_filled</span>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No registration records found</h3>
                    <p class="text-gray-500 mb-6">Get started by registering your first vehicle</p>
                    <button onclick="window.location.href='VehicleRegistration.html'"
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200">
                        Register Vehicle
                    </button>
                </div>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="hidden mt-6 flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    Showing <span id="showingFrom">1</span> to <span id="showingTo">10</span> of <span
                        id="totalRecords">0</span> results
                </div>
                <div class="flex space-x-2">
                    <button onclick="previousPage()" id="prevBtn"
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <div id="pageNumbers" class="flex space-x-1">
                        <!-- Page numbers will be populated here -->
                    </div>
                    <button onclick="nextPage()" id="nextBtn"
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewModal" class="modal fixed inset-0 z-50">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div
            class="modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-3/4 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Vehicle Registration Details</h2>
                <button onclick="closeViewModal()" class="text-gray-600 hover:text-gray-800">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div id="modalContent">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Edit Record Modal -->
    <div id="editModal" class="modal fixed inset-0 z-50">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl mx-4">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                <div class="flex items-center">
                    <span class="material-icons text-blue-600 mr-2">edit</span>
                    <h3 class="text-2xl font-semibold text-gray-900">Edit Vehicle Registration</h3>
                </div>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition duration-200">
                    <span class="material-icons text-2xl">close</span>
                </button>
            </div>

            <!-- Edit Form -->
            <form id="editVehicleForm" class="space-y-8">
                <input type="hidden" id="edit_record_id" name="record_id">
                
                <!-- Vehicle Owner Information -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="material-icons mr-2 text-green-600">person</span>
                        Vehicle Owner Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="edit_owner_full_name" class="block text-sm font-medium text-gray-700 mb-2">
                                Full Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="edit_owner_full_name" name="owner_full_name" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_owner_contact" class="block text-sm font-medium text-gray-700 mb-2">
                                Contact Number <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" id="edit_owner_contact" name="owner_contact" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_owner_email" class="block text-sm font-medium text-gray-700 mb-2">
                                Email Address <span class="text-red-500">*</span>
                            </label>
                            <input type="email" id="edit_owner_email" name="owner_email" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_owner_tin" class="block text-sm font-medium text-gray-700 mb-2">
                                TIN Number
                            </label>
                            <input type="text" id="edit_owner_tin" name="owner_tin"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div class="md:col-span-2">
                            <label for="edit_owner_postal_address" class="block text-sm font-medium text-gray-700 mb-2">
                                Postal Address <span class="text-red-500">*</span>
                            </label>
                            <textarea id="edit_owner_postal_address" name="owner_postal_address" required rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="edit_owner_residential_address" class="block text-sm font-medium text-gray-700 mb-2">
                                Residential Address <span class="text-red-500">*</span>
                            </label>
                            <textarea id="edit_owner_residential_address" name="owner_residential_address" required rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Information -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="material-icons mr-2 text-green-600">directions_car</span>
                        Vehicle Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="edit_registration_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Registration Number <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="edit_registration_number" name="registration_number" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200"
                                style="text-transform: uppercase;">
                        </div>
                        <div>
                            <label for="edit_vehicle_make" class="block text-sm font-medium text-gray-700 mb-2">
                                Vehicle Make <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="edit_vehicle_make" name="vehicle_make" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_model_name" class="block text-sm font-medium text-gray-700 mb-2">
                                Model Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="edit_model_name" name="model_name" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_year_of_manufacture" class="block text-sm font-medium text-gray-700 mb-2">
                                Year of Manufacture <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="edit_year_of_manufacture" name="year_of_manufacture" required
                                min="1900" max="2025"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_chassis_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Chassis Number <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="edit_chassis_number" name="chassis_number" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_engine_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Engine Number <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="edit_engine_number" name="engine_number" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_body_type" class="block text-sm font-medium text-gray-700 mb-2">
                                Body Type <span class="text-red-500">*</span>
                            </label>
                            <select id="edit_body_type" name="body_type" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                                <option value="">Select body type</option>
                                <option value="Sedan">Sedan</option>
                                <option value="SUV">SUV</option>
                                <option value="Hatchback">Hatchback</option>
                                <option value="Coupe">Coupe</option>
                                <option value="Convertible">Convertible</option>
                                <option value="Wagon">Wagon</option>
                                <option value="Pickup">Pickup</option>
                                <option value="Van">Van</option>
                                <option value="Truck">Truck</option>
                                <option value="Motorcycle">Motorcycle</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit_color" class="block text-sm font-medium text-gray-700 mb-2">
                                Color <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="edit_color" name="color" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_fuel_type" class="block text-sm font-medium text-gray-700 mb-2">
                                Fuel Type <span class="text-red-500">*</span>
                            </label>
                            <select id="edit_fuel_type" name="fuel_type" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                                <option value="">Select fuel type</option>
                                <option value="Petrol">Petrol</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Electric">Electric</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="CNG">CNG</option>
                                <option value="LPG">LPG</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit_vehicle_use" class="block text-sm font-medium text-gray-700 mb-2">
                                Vehicle Use <span class="text-red-500">*</span>
                            </label>
                            <select id="edit_vehicle_use" name="vehicle_use" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                                <option value="">Select vehicle use</option>
                                <option value="Private">Private</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Government">Government</option>
                                <option value="Diplomatic">Diplomatic</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit_cubic_capacity" class="block text-sm font-medium text-gray-700 mb-2">
                                Cubic Capacity (CC)
                            </label>
                            <input type="number" id="edit_cubic_capacity" name="cubic_capacity"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_number_of_cylinders" class="block text-sm font-medium text-gray-700 mb-2">
                                Number of Cylinders
                            </label>
                            <input type="number" id="edit_number_of_cylinders" name="number_of_cylinders"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="edit_declaration_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Declaration Number
                            </label>
                            <input type="text" id="edit_declaration_number" name="declaration_number"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="edit_remarks" class="block text-sm font-medium text-gray-700 mb-2">
                                Remarks
                            </label>
                            <textarea id="edit_remarks" name="remarks" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeEditModal()"
                        class="flex items-center px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        <span class="material-icons mr-2">close</span>
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex items-center px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 font-medium shadow-lg">
                        <span class="material-icons mr-2">save</span>
                        Update Record
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Certificate Generation Modal -->
    <div id="certificateModal" class="modal fixed inset-0 z-50">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl mx-4">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                <div class="flex items-center">
                    <span class="material-icons text-green-600 mr-2">description</span>
                    <h3 class="text-2xl font-semibold text-gray-900">Generate Registration Certificate</h3>
                </div>
                <button onclick="closeCertificateModal()" class="text-gray-400 hover:text-gray-600 transition duration-200">
                    <span class="material-icons text-2xl">close</span>
                </button>
            </div>

            <!-- Certificate Preview -->
            <div id="certificatePreview" class="bg-white border-2 border-gray-300 rounded-lg p-8 mb-6" style="min-height: 600px;">
                <!-- Certificate content will be generated here -->
            </div>

            <!-- Certificate Options -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificate Type</label>
                    <select id="certificateType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="registration">Vehicle Registration Certificate</option>
                        <option value="ownership">Certificate of Ownership</option>
                        <option value="roadworthy">Roadworthy Certificate</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Issue Date</label>
                    <input type="date" id="certificateIssueDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valid Until</label>
                    <input type="date" id="certificateValidUntil" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Issuing Officer</label>
                    <select id="issuingOfficer" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">Select Officer</option>
                        <option value="Mr. Addison">Mr. Addison</option>
                        <option value="Mr. Bona">Mr. Bona</option>
                        <option value="Mr. Adams">Mr. Adams</option>
                        <option value="Mrs. Johnson">Mrs. Johnson</option>
                        <option value="Mr. Smith">Mr. Smith</option>
                    </select>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <button onclick="closeCertificateModal()"
                    class="flex items-center px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                    <span class="material-icons mr-2">close</span>
                    Cancel
                </button>
                <button onclick="previewCertificate()"
                    class="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    <span class="material-icons mr-2">visibility</span>
                    Preview
                </button>
                <button onclick="downloadCertificate()"
                    class="flex items-center px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 font-medium shadow-lg">
                    <span class="material-icons mr-2">download</span>
                    Download PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Success/Error Modals -->
    <div id="successModal" class="modal fixed inset-0 z-50">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div
            class="modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                    <span class="material-icons text-green-600 text-3xl">check_circle</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2" id="successTitle">Success!</h3>
                <p class="text-gray-600 mb-6" id="successMessage">Operation completed successfully!</p>
                <button onclick="closeSuccessModal()"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 1;
        let recordsPerPage = 10;
        let totalPages = 1;
        let allRecords = [];
        let filteredRecords = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadRegistrationRecords();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(searchRecords, 300));
            document.getElementById('statusFilter').addEventListener('change', searchRecords);
            document.getElementById('yearFilter').addEventListener('change', searchRecords);
            document.getElementById('startDate').addEventListener('change', searchRecords);
            document.getElementById('endDate').addEventListener('change', searchRecords);
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Load registration records
        async function loadRegistrationRecords() {
            try {
                showLoading();

                // Call the actual API endpoint
                const response = await fetch('http://localhost/VIR/backend/api/vehicle_registration.php');

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        allRecords = result.data;
                    } else {
                        throw new Error(result.message || 'Failed to load records');
                    }
                } else {
                    throw new Error('Failed to fetch records');
                }

                filteredRecords = [...allRecords];
                updateStatistics();
                displayRecords();
                hideLoading();

            } catch (error) {
                console.error('Error loading records:', error);
                console.log('Using mock data due to error');

                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                errorDiv.innerHTML = `
                    <strong>Error loading data:</strong> ${error.message}<br>
                    <small>Using sample data for demonstration. Check console for details.</small>
                `;
                document.querySelector('.flex-1.p-8').insertBefore(errorDiv, document.querySelector('.flex-1.p-8').firstChild);

                // Use mock data on error
                allRecords = generateMockData();
                filteredRecords = [...allRecords];
                updateStatistics();
                displayRecords();
                hideLoading();
            }
        }

        // Generate mock data for demonstration
        function generateMockData() {
            const mockData = [];
            const makes = ['Toyota', 'Honda', 'Ford', 'BMW', 'Mercedes', 'Audi', 'Nissan', 'Hyundai'];
            const models = ['Camry', 'Civic', 'Focus', 'X5', 'C-Class', 'A4', 'Altima', 'Elantra'];
            const statuses = ['active', 'pending', 'expired'];
            const colors = ['White', 'Black', 'Silver', 'Red', 'Blue', 'Gray'];

            for (let i = 1; i <= 50; i++) {
                const make = makes[Math.floor(Math.random() * makes.length)];
                const model = models[Math.floor(Math.random() * models.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const year = 2020 + Math.floor(Math.random() * 5);

                mockData.push({
                    id: i,
                    vehicle_number: `ABC-${String(i).padStart(4, '0')}`,
                    vehicle_make: make,
                    model_name: model,
                    year_of_manufacture: year,
                    chassis_number: `CH${String(i).padStart(8, '0')}`,
                    engine_number: `EN${String(i).padStart(8, '0')}`,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    owner_full_name: `Owner ${i}`,
                    owner_contact: `+233${String(Math.floor(Math.random() * 1000000000)).padStart(9, '0')}`,
                    owner_email: `owner${i}@example.com`,
                    registration_date: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
                    status: status,
                    fuel_type: ['Petrol', 'Diesel', 'Electric'][Math.floor(Math.random() * 3)],
                    body_type: ['Sedan', 'SUV', 'Hatchback'][Math.floor(Math.random() * 3)]
                });
            }

            return mockData;
        }

        // Update statistics
        async function updateStatistics() {
            try {
                const response = await fetch('http://localhost/VIR/backend/api/vehicle_statistics.php?type=registration_records');
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('totalRegistered').textContent = data.data.total || 0;
                    document.getElementById('todayCount').textContent = data.data.today || 0;
                    document.getElementById('weekCount').textContent = data.data.week || 0;
                    document.getElementById('monthlyCount').textContent = data.data.month || 0;
                    document.getElementById('deletedCount').textContent = data.data.deleted || 0;
                } else {
                    console.error('Failed to fetch statistics:', data.message);
                    // Fallback to mock data calculation
                    const total = allRecords.length;
                    const today = allRecords.filter(r => {
                        const regDate = new Date(r.registration_date);
                        const now = new Date();
                        return regDate.toDateString() === now.toDateString();
                    }).length;
                    const thisWeek = allRecords.filter(r => {
                        const regDate = new Date(r.registration_date);
                        const now = new Date();
                        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                        return regDate >= weekStart;
                    }).length;
                    const thisMonth = allRecords.filter(r => {
                        const regDate = new Date(r.registration_date);
                        const now = new Date();
                        return regDate.getMonth() === now.getMonth() && regDate.getFullYear() === now.getFullYear();
                    }).length;
                    const deleted = allRecords.filter(r => r.status === 'Inactive' || r.status === 'inactive').length;

                    document.getElementById('totalRegistered').textContent = total;
                    document.getElementById('todayCount').textContent = today;
                    document.getElementById('weekCount').textContent = thisWeek;
                    document.getElementById('monthlyCount').textContent = thisMonth;
                    document.getElementById('deletedCount').textContent = deleted;
                }
            } catch (error) {
                console.error('Error fetching statistics:', error);
                // Fallback to mock data calculation
                const total = allRecords.length;
                const today = allRecords.filter(r => {
                    const regDate = new Date(r.registration_date);
                    const now = new Date();
                    return regDate.toDateString() === now.toDateString();
                }).length;
                const thisWeek = allRecords.filter(r => {
                    const regDate = new Date(r.registration_date);
                    const now = new Date();
                    const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                    return regDate >= weekStart;
                }).length;
                const thisMonth = allRecords.filter(r => {
                    const regDate = new Date(r.registration_date);
                    const now = new Date();
                    return regDate.getMonth() === now.getMonth() && regDate.getFullYear() === now.getFullYear();
                }).length;
                const deleted = allRecords.filter(r => r.status === 'Inactive' || r.status === 'inactive').length;

                document.getElementById('totalRegistered').textContent = total;
                document.getElementById('todayCount').textContent = today;
                document.getElementById('weekCount').textContent = thisWeek;
                document.getElementById('monthlyCount').textContent = thisMonth;
                document.getElementById('deletedCount').textContent = deleted;
            }
        }

        // Search and filter records
        function searchRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredRecords = allRecords.filter(record => {
                const matchesSearch = !searchTerm ||
                    record.vehicle_number.toLowerCase().includes(searchTerm) ||
                    record.chassis_number.toLowerCase().includes(searchTerm) ||
                    record.owner_full_name.toLowerCase().includes(searchTerm) ||
                    record.vehicle_make.toLowerCase().includes(searchTerm);

                const matchesStatus = !statusFilter || record.status === statusFilter;
                const matchesYear = !yearFilter || record.year_of_manufacture.toString() === yearFilter;

                // Date range filtering
                let matchesDateRange = true;
                if (startDate || endDate) {
                    const recordDate = new Date(record.registration_date);

                    if (startDate) {
                        const start = new Date(startDate);
                        matchesDateRange = matchesDateRange && recordDate >= start;
                    }

                    if (endDate) {
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999); // Include the entire end date
                        matchesDateRange = matchesDateRange && recordDate <= end;
                    }
                }

                return matchesSearch && matchesStatus && matchesYear && matchesDateRange;
            });

            currentPage = 1;
            displayRecords();
        }

        // Set date range based on predefined periods
        function setDateRange(period) {
            const today = new Date();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            let startDate, endDate;

            switch (period) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;

                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // End of week (Saturday)
                    break;

                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1); // First day of month
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // Last day of month
                    break;

                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1); // First day of year
                    endDate = new Date(today.getFullYear(), 11, 31); // Last day of year
                    break;

                default:
                    return;
            }

            // Format dates for input fields (YYYY-MM-DD)
            startDateInput.value = startDate.toISOString().split('T')[0];
            endDateInput.value = endDate.toISOString().split('T')[0];

            // Trigger search
            searchRecords();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            filteredRecords = [...allRecords];
            currentPage = 1;
            displayRecords();
        }

        // Display records in table
        function displayRecords() {
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const recordsToShow = filteredRecords.slice(startIndex, endIndex);

            if (filteredRecords.length === 0) {
                showEmptyState();
                return;
            }

            hideEmptyState();
            showTable();

            const tbody = document.getElementById('recordsTableBody');
            tbody.innerHTML = '';

            recordsToShow.forEach(record => {
                const row = createTableRow(record);
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // Create table row
        function createTableRow(record) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition duration-200';

            const statusClass = `status-${record.status}`;
            const statusText = record.status.charAt(0).toUpperCase() + record.status.slice(1);

            row.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${record.vehicle_number || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${record.owner_full_name || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.owner_postal_address || record.owner_residential_address || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.chassis_number || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.vehicle_make || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.model_name || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.year_of_manufacture || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.cubic_capacity || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.number_of_cylinders || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.declaration_number || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.vehicle_use || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${record.remarks || 'N/A'}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${formatDate(record.registration_date || record.created_at)}</div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-1">
                        <button onclick="viewRecord(${record.id})" 
                            class="text-blue-600 hover:text-blue-900 transition duration-200" title="View Details">
                            <span class="material-icons text-sm">visibility</span>
                        </button>
                        <button onclick="editRecord(${record.id})" 
                            class="text-green-600 hover:text-green-900 transition duration-200" title="Edit">
                            <span class="material-icons text-sm">edit</span>
                        </button>
                        <button onclick="changeOwner(${record.id})" 
                            class="text-orange-600 hover:text-orange-900 transition duration-200" title="Change Owner">
                            <span class="material-icons text-sm">sync_alt</span>
                        </button>
                        <button onclick="generateCertificate(${record.id})" 
                            class="text-purple-600 hover:text-purple-900 transition duration-200" title="Generate Certificate">
                            <span class="material-icons text-sm">description</span>
                        </button>
                        <button onclick="deleteRecord(${record.id})" 
                            class="text-red-600 hover:text-red-900 transition duration-200" title="Delete">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </td>
            `;

            return row;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Update pagination
        function updatePagination() {
            totalPages = Math.ceil(filteredRecords.length / recordsPerPage);

            if (totalPages <= 1) {
                document.getElementById('paginationContainer').classList.add('hidden');
                return;
            }

            document.getElementById('paginationContainer').classList.remove('hidden');

            const startRecord = (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, filteredRecords.length);

            document.getElementById('showingFrom').textContent = startRecord;
            document.getElementById('showingTo').textContent = endRecord;
            document.getElementById('totalRecords').textContent = filteredRecords.length;

            // Update page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `px-3 py-2 border rounded-lg transition duration-200 ${i === currentPage
                        ? 'bg-green-600 text-white border-green-600'
                        : 'border-gray-300 hover:bg-gray-50'
                        }`;
                    pageBtn.onclick = () => goToPage(i);
                    pageNumbers.appendChild(pageBtn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-3 py-2';
                    pageNumbers.appendChild(ellipsis);
                }
            }

            // Update prev/next buttons
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayRecords();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                displayRecords();
            }
        }

        function goToPage(page) {
            currentPage = page;
            displayRecords();
        }

        // Record actions
        function viewRecord(id) {
            console.log('viewRecord called with id:', id, 'type:', typeof id);
            console.log('allRecords length:', allRecords.length);
            // Convert id to number to ensure proper comparison
            const numericId = parseInt(id);
            const record = allRecords.find(r => r.id == numericId || r.id == id);
            console.log('Found record:', record);
            if (!record) {
                console.error('Record not found for id:', id);
                alert('Record not found! Available IDs: ' + allRecords.map(r => r.id).join(', '));
                return;
            }

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="space-y-8">
                    <!-- Vehicle Owner Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="material-icons mr-2 text-green-600">person</span>
                            Vehicle Owner Information
                        </h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Full Name:</span>
                                    <p class="text-gray-900 font-medium">${record.owner_full_name || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Contact Number:</span>
                                    <p class="text-gray-900">${record.owner_contact || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Email Address:</span>
                                    <p class="text-gray-900">${record.owner_email || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">TIN Number:</span>
                                    <p class="text-gray-900">${record.owner_tin || '-'}</p>
                                </div>
                                <div class="md:col-span-2">
                                    <span class="text-sm font-medium text-gray-600">Postal Address:</span>
                                    <p class="text-gray-900">${record.owner_postal_address || '-'}</p>
                                </div>
                                <div class="md:col-span-2">
                                    <span class="text-sm font-medium text-gray-600">Residential Address:</span>
                                    <p class="text-gray-900">${record.owner_residential_address || '-'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="material-icons mr-2 text-green-600">directions_car</span>
                            Vehicle Information
                        </h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Registration Number:</span>
                                    <p class="text-gray-900 font-semibold text-lg">${record.vehicle_number || record.registration_number || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Vehicle Make:</span>
                                    <p class="text-gray-900">${record.vehicle_make || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Model Name:</span>
                                    <p class="text-gray-900">${record.model_name || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Year of Manufacture:</span>
                                    <p class="text-gray-900">${record.year_of_manufacture || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Chassis Number:</span>
                                    <p class="text-gray-900 font-mono text-sm">${record.chassis_number || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Engine Number:</span>
                                    <p class="text-gray-900 font-mono text-sm">${record.engine_number || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Body Type:</span>
                                    <p class="text-gray-900">${record.body_type || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Color:</span>
                                    <p class="text-gray-900">${record.color || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Fuel Type:</span>
                                    <p class="text-gray-900">${record.fuel_type || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Vehicle Use:</span>
                                    <p class="text-gray-900">${record.vehicle_use || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Cubic Capacity (CC):</span>
                                    <p class="text-gray-900">${record.cubic_capacity || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Number of Cylinders:</span>
                                    <p class="text-gray-900">${record.number_of_cylinders || record.cylinders || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Declaration Number:</span>
                                    <p class="text-gray-900">${record.declaration_number || '-'}</p>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <span class="text-sm font-medium text-gray-600">Remarks:</span>
                                    <p class="text-gray-900">${record.remarks || '-'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Registration Information -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="material-icons mr-2 text-green-600">assignment</span>
                            Registration Information
                        </h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Registration Date:</span>
                                    <p class="text-gray-900">${formatDate(record.registration_date || record.created_at) || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Status:</span>
                                    <p class="text-gray-900">
                                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${getStatusClass(record.status)}">
                                            ${(record.status || 'active').charAt(0).toUpperCase() + (record.status || 'active').slice(1)}
                                        </span>
                                    </p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Last Updated:</span>
                                    <p class="text-gray-900">${formatDate(record.updated_at) || formatDate(record.created_at) || '-'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer with Actions -->
                <div class="flex justify-end space-x-4 pt-6 mt-6 border-t border-gray-200">
                    <button onclick="closeViewModal()"
                        class="flex items-center px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        <span class="material-icons mr-2">close</span>
                        Close
                    </button>
                    <button onclick="editRecord(${record.id})"
                        class="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        <span class="material-icons mr-2">edit</span>
                        Edit Record
                    </button>
                    <button onclick="generateCertificate(${record.id})"
                        class="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                        <span class="material-icons mr-2">description</span>
                        Generate Certificate
                    </button>
                </div>
            `;

            console.log('About to show modal');
            const modal = document.getElementById('viewModal');
            console.log('Modal element:', modal);
            modal.classList.add('show');
            console.log('Modal classes after adding show:', modal.classList);
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function editRecord(id) {
            console.log('editRecord called with id:', id, 'type:', typeof id);
            console.log('allRecords length:', allRecords.length);
            
            // Convert id to number to ensure proper comparison
            const numericId = parseInt(id);
            const record = allRecords.find(r => r.id == numericId || r.id == id);
            console.log('Found record for editing:', record);
            
            if (!record) {
                console.error('Record not found for editing id:', id);
                alert('Record not found for editing! Available IDs: ' + allRecords.map(r => r.id).join(', '));
                return;
            }

            // Populate the edit form with current data
            populateEditForm(record);

            // Show the edit modal
            console.log('About to show edit modal');
            const modal = document.getElementById('editModal');
            console.log('Edit modal element:', modal);
            modal.classList.add('show');
            console.log('Edit modal classes after adding show:', modal.classList);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function generateCertificate(id) {
            console.log('generateCertificate called with id:', id, 'type:', typeof id);
            console.log('allRecords length:', allRecords.length);
            
            // Convert id to number to ensure proper comparison
            const numericId = parseInt(id);
            const record = allRecords.find(r => r.id == numericId || r.id == id);
            console.log('Found record for certificate generation:', record);
            
            if (!record) {
                console.error('Record not found for certificate generation id:', id);
                alert('Record not found for certificate generation! Available IDs: ' + allRecords.map(r => r.id).join(', '));
                return;
            }

            // Show certificate generation modal
            showCertificateModal(record);
        }

        async function deleteRecord(id) {
            console.log('deleteRecord called with id:', id, 'type:', typeof id);
            console.log('allRecords length:', allRecords.length);
            
            // Convert id to number to ensure proper comparison
            const numericId = parseInt(id);
            const record = allRecords.find(r => r.id == numericId || r.id == id);
            console.log('Found record for deletion:', record);
            
            if (!record) {
                console.error('Record not found for deletion id:', id);
                alert('Record not found for deletion! Available IDs: ' + allRecords.map(r => r.id).join(', '));
                return;
            }

            // Show detailed confirmation with vehicle information
            const vehicleInfo = record.vehicle_number || record.registration_number || 'Unknown Vehicle';
            const ownerInfo = record.owner_full_name || 'Unknown Owner';
            
            const confirmMessage = `Are you sure you want to delete this registration record?\n\nVehicle: ${vehicleInfo}\nOwner: ${ownerInfo}\n\nThis action cannot be undone.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Show loading state
                const deleteBtn = document.querySelector(`button[onclick="deleteRecord(${id})"]`);
                if (deleteBtn) {
                    const originalHTML = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<span class="material-icons animate-spin text-sm">refresh</span>';
                    deleteBtn.disabled = true;
                    
                    // Restore button after operation
                    setTimeout(() => {
                        deleteBtn.innerHTML = originalHTML;
                        deleteBtn.disabled = false;
                    }, 2000);
                }

                // Call the delete API endpoint
                const response = await fetch(`http://localhost/VIR/backend/api/vehicle_registration.php?id=${numericId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('Delete API response:', response);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Delete API result:', result);
                    
                    if (result.status === 'success') {
                        // Update record status to 'Inactive' in local arrays (soft delete)
                        const recordIndex = allRecords.findIndex(r => r.id == numericId || r.id == id);
                        if (recordIndex !== -1) {
                            allRecords[recordIndex].status = 'Inactive';
                            allRecords[recordIndex].updated_at = new Date().toISOString();
                        }
                        
                        const filteredIndex = filteredRecords.findIndex(r => r.id == numericId || r.id == id);
                        if (filteredIndex !== -1) {
                            filteredRecords[filteredIndex].status = 'Inactive';
                            filteredRecords[filteredIndex].updated_at = new Date().toISOString();
                        }
                        
                        // Option 1: Remove inactive records from display (recommended)
                        allRecords = allRecords.filter(r => r.status !== 'Inactive');
                        filteredRecords = filteredRecords.filter(r => r.status !== 'Inactive');
                        
                        // Update display
                        updateStatistics();
                        displayRecords();
                        
                        // Show success message
                        showSuccessModal('Record Deleted', `Registration record for ${vehicleInfo} has been deactivated and removed from the active records list.`);
                        
                        console.log('Record soft deleted successfully - status updated to Inactive and removed from display');
                    } else {
                        throw new Error(result.message || 'Delete operation failed');
                    }
                } else {
                    // If API call fails, try to get error message
                    let errorMessage = 'Failed to delete record from database';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error('Delete error:', error);
                
                // Show user-friendly error message
                const errorMsg = error.message || 'An error occurred while deleting the record';
                alert(`Error deleting record: ${errorMsg}\n\nThe record may still exist in the database. Please refresh the page and try again.`);
                
                // Optionally reload records from server to ensure consistency
                if (confirm('Would you like to refresh the records from the server to ensure data consistency?')) {
                    loadRegistrationRecords();
                }
            }
        }

        function changeOwner(id) {
            console.log('changeOwner called with id:', id, 'type:', typeof id);
            console.log('allRecords length:', allRecords.length);
            
            // Convert id to number to ensure proper comparison
            const numericId = parseInt(id);
            const record = allRecords.find(r => r.id == numericId || r.id == id);
            console.log('Found record for ownership change:', record);
            
            if (!record) {
                console.error('Record not found for ownership change id:', id);
                alert('Record not found for ownership change! Available IDs: ' + allRecords.map(r => r.id).join(', '));
                return;
            }

            // Store the record data in localStorage to pass to change owner page
            const vehicleData = {
                // Vehicle Information
                vehicle_number: record.vehicle_number || record.registration_number || '',
                chassis_number: record.chassis_number || '',
                engine_number: record.engine_number || '',
                vehicle_make: record.vehicle_make || '',
                model_name: record.model_name || '',
                year_of_manufacture: record.year_of_manufacture || '',
                body_type: record.body_type || '',
                color: record.color || '',
                fuel_type: record.fuel_type || '',
                cubic_capacity: record.cubic_capacity || '',
                number_of_cylinders: record.number_of_cylinders || record.cylinders || '',
                vehicle_use: record.vehicle_use || '',
                declaration_number: record.declaration_number || '',

                // Current Owner Information (will become previous owner)
                current_owner_full_name: record.owner_full_name || '',
                current_owner_postal_address: record.owner_postal_address || '',
                current_owner_residential_address: record.owner_residential_address || '',
                current_owner_contact: record.owner_contact || '',
                current_owner_email: record.owner_email || '',
                current_owner_tin: record.owner_tin || '',

                // Additional info
                registration_date: record.registration_date || record.created_at || '',
                record_id: record.id
            };

            console.log('Vehicle data to be stored:', vehicleData);

            // Store in localStorage
            localStorage.setItem('changeOwnerVehicleData', JSON.stringify(vehicleData));
            console.log('Vehicle data stored in localStorage');

            // Show success message and redirect
            showSuccessModal('Data Loaded', 'Vehicle information has been loaded. Redirecting to Change Owner page...');

            // Redirect after a short delay
            setTimeout(() => {
                console.log('Redirecting to changeowner.html');
                window.location.href = 'changeowner.html';
            }, 1500);
        }

        function exportRecords() {
            console.log('Starting Excel export...');
            
            // Show loading state
            const exportBtn = document.querySelector('button[onclick="exportRecords()"]');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<span class="material-icons mr-2 animate-spin">refresh</span>Exporting...';
            exportBtn.disabled = true;

            try {
                // Use filtered records if search is active, otherwise use all records
                const recordsToExport = filteredRecords.length > 0 ? filteredRecords : allRecords;
                
                if (recordsToExport.length === 0) {
                    alert('No records to export');
                    return;
                }

                console.log(`Exporting ${recordsToExport.length} records to Excel`);

                // Prepare data for Excel export
                const excelData = recordsToExport.map((record, index) => ({
                    'S/N': index + 1,
                    'Registration No.': record.vehicle_number || record.registration_number || '',
                    'Owner Name': record.owner_full_name || '',
                    'Contact': record.owner_contact || '',
                    'Email': record.owner_email || '',
                    'TIN': record.owner_tin || '',
                    'Postal Address': record.owner_postal_address || '',
                    'Residential Address': record.owner_residential_address || '',
                    'Vehicle Make': record.vehicle_make || '',
                    'Model': record.model_name || '',
                    'Year': record.year_of_manufacture || '',
                    'Chassis Number': record.chassis_number || '',
                    'Engine Number': record.engine_number || '',
                    'Body Type': record.body_type || '',
                    'Color': record.color || '',
                    'Fuel Type': record.fuel_type || '',
                    'Vehicle Use': record.vehicle_use || '',
                    'Cubic Capacity (CC)': record.cubic_capacity || '',
                    'No. of Cylinders': record.number_of_cylinders || record.cylinders || '',
                    'Declaration No.': record.declaration_number || '',
                    'Remarks': record.remarks || '',
                    'Registration Date': formatDate(record.registration_date || record.created_at) || '',
                    'Last Updated': formatDate(record.updated_at || record.created_at) || '',
                    'Status': record.status || 'active'
                }));

                // Create workbook and worksheet
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.json_to_sheet(excelData);

                // Set column widths for better readability
                const columnWidths = [
                    { wch: 5 },   // S/N
                    { wch: 15 },  // Registration No.
                    { wch: 20 },  // Owner Name
                    { wch: 15 },  // Contact
                    { wch: 25 },  // Email
                    { wch: 12 },  // TIN
                    { wch: 30 },  // Postal Address
                    { wch: 30 },  // Residential Address
                    { wch: 12 },  // Vehicle Make
                    { wch: 12 },  // Model
                    { wch: 8 },   // Year
                    { wch: 20 },  // Chassis Number
                    { wch: 15 },  // Engine Number
                    { wch: 12 },  // Body Type
                    { wch: 10 },  // Color
                    { wch: 10 },  // Fuel Type
                    { wch: 12 },  // Vehicle Use
                    { wch: 12 },  // Cubic Capacity
                    { wch: 12 },  // No. of Cylinders
                    { wch: 15 },  // Declaration No.
                    { wch: 20 },  // Remarks
                    { wch: 15 },  // Registration Date
                    { wch: 15 },  // Last Updated
                    { wch: 10 }   // Status
                ];
                worksheet['!cols'] = columnWidths;

                // Style the header row
                const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!worksheet[cellAddress]) continue;
                    
                    worksheet[cellAddress].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "2D5A27" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Vehicle Registration Records');

                // Add summary sheet
                const summaryData = [
                    { 'Summary': 'Total Records', 'Value': recordsToExport.length },
                    { 'Summary': 'Export Date', 'Value': new Date().toLocaleString() },
                    { 'Summary': 'Export Type', 'Value': filteredRecords.length > 0 ? 'Filtered Records' : 'All Records' },
                    { 'Summary': '', 'Value': '' },
                    { 'Summary': 'Status Breakdown', 'Value': '' },
                    { 'Summary': 'Active Records', 'Value': recordsToExport.filter(r => (r.status || 'active') === 'active').length },
                    { 'Summary': 'Pending Records', 'Value': recordsToExport.filter(r => r.status === 'pending').length },
                    { 'Summary': 'Expired Records', 'Value': recordsToExport.filter(r => r.status === 'expired').length }
                ];

                const summaryWorksheet = XLSX.utils.json_to_sheet(summaryData);
                summaryWorksheet['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(workbook, summaryWorksheet, 'Summary');

                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `Vehicle_Registration_Records_${timestamp}.xlsx`;

                // Write and download the file
                XLSX.writeFile(workbook, filename);

                console.log(`Excel file generated: ${filename}`);
                
                // Show success message
                showSuccessModal('Export Successful', `${recordsToExport.length} records have been exported to Excel successfully. File: ${filename}`);

            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting records: ' + error.message);
            } finally {
                // Reset button state
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }, 1000);
            }
        }

        // Advanced export with multiple options
        function showExportOptions() {
            const exportModal = document.createElement('div');
            exportModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            exportModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Export Options</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                            <select id="exportFormat" class="w-full border border-gray-300 rounded-lg p-2">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data to Export</label>
                            <select id="exportScope" class="w-full border border-gray-300 rounded-lg p-2">
                                <option value="filtered">Current View (${filteredRecords.length} records)</option>
                                <option value="all">All Records (${allRecords.length} records)</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="includeSummary" checked class="mr-2">
                                <span class="text-sm text-gray-700">Include Summary Sheet</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="executeExport()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Export
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(exportModal);
        }

        function executeExport() {
            const format = document.getElementById('exportFormat').value;
            const scope = document.getElementById('exportScope').value;
            const includeSummary = document.getElementById('includeSummary').checked;
            
            // Close modal
            document.querySelector('.fixed.inset-0.z-50').remove();
            
            if (format === 'xlsx') {
                exportToExcel(scope, includeSummary);
            } else if (format === 'csv') {
                exportToCSV(scope);
            }
        }

        function exportToExcel(scope, includeSummary) {
            const recordsToExport = scope === 'all' ? allRecords : filteredRecords;
            
            if (recordsToExport.length === 0) {
                alert('No records to export');
                return;
            }

            // Show loading
            const exportBtn = document.querySelector('button[onclick="exportRecords()"]');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<span class="material-icons mr-2 animate-spin">refresh</span>Exporting...';
            exportBtn.disabled = true;

            try {
                const workbook = XLSX.utils.book_new();
                
                // Main data sheet
                const excelData = recordsToExport.map((record, index) => ({
                    'S/N': index + 1,
                    'Registration No.': record.vehicle_number || record.registration_number || '',
                    'Owner Name': record.owner_full_name || '',
                    'Contact': record.owner_contact || '',
                    'Email': record.owner_email || '',
                    'TIN': record.owner_tin || '',
                    'Postal Address': record.owner_postal_address || '',
                    'Residential Address': record.owner_residential_address || '',
                    'Vehicle Make': record.vehicle_make || '',
                    'Model': record.model_name || '',
                    'Year': record.year_of_manufacture || '',
                    'Chassis Number': record.chassis_number || '',
                    'Engine Number': record.engine_number || '',
                    'Body Type': record.body_type || '',
                    'Color': record.color || '',
                    'Fuel Type': record.fuel_type || '',
                    'Vehicle Use': record.vehicle_use || '',
                    'Cubic Capacity (CC)': record.cubic_capacity || '',
                    'No. of Cylinders': record.number_of_cylinders || record.cylinders || '',
                    'Declaration No.': record.declaration_number || '',
                    'Remarks': record.remarks || '',
                    'Registration Date': formatDate(record.registration_date || record.created_at) || '',
                    'Status': record.status || 'active'
                }));

                const worksheet = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths
                worksheet['!cols'] = [
                    { wch: 5 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 25 }, { wch: 12 },
                    { wch: 30 }, { wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 8 }, { wch: 20 },
                    { wch: 15 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 12 },
                    { wch: 12 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 10 }
                ];

                XLSX.utils.book_append_sheet(workbook, worksheet, 'Vehicle Records');

                // Add summary sheet if requested
                if (includeSummary) {
                    const summaryData = [
                        { 'Summary': 'Total Records', 'Value': recordsToExport.length },
                        { 'Summary': 'Export Date', 'Value': new Date().toLocaleString() },
                        { 'Summary': 'Export Scope', 'Value': scope === 'all' ? 'All Records' : 'Filtered Records' },
                        { 'Summary': '', 'Value': '' },
                        { 'Summary': 'Status Breakdown', 'Value': '' },
                        { 'Summary': 'Active', 'Value': recordsToExport.filter(r => (r.status || 'active') === 'active').length },
                        { 'Summary': 'Pending', 'Value': recordsToExport.filter(r => r.status === 'pending').length },
                        { 'Summary': 'Expired', 'Value': recordsToExport.filter(r => r.status === 'expired').length }
                    ];

                    const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                    summarySheet['!cols'] = [{ wch: 20 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                }

                // Generate filename
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `DVLA_Vehicle_Records_${timestamp}.xlsx`;

                // Download file
                XLSX.writeFile(workbook, filename);
                
                showSuccessModal('Export Successful', `${recordsToExport.length} records exported to ${filename}`);

            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting to Excel: ' + error.message);
            } finally {
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }, 1000);
            }
        }

        function exportToCSV(scope) {
            const recordsToExport = scope === 'all' ? allRecords : filteredRecords;
            
            if (recordsToExport.length === 0) {
                alert('No records to export');
                return;
            }

            try {
                // Prepare CSV data
                const csvData = recordsToExport.map((record, index) => ({
                    'S/N': index + 1,
                    'Registration No.': record.vehicle_number || record.registration_number || '',
                    'Owner Name': record.owner_full_name || '',
                    'Contact': record.owner_contact || '',
                    'Email': record.owner_email || '',
                    'Vehicle Make': record.vehicle_make || '',
                    'Model': record.model_name || '',
                    'Year': record.year_of_manufacture || '',
                    'Chassis Number': record.chassis_number || '',
                    'Status': record.status || 'active'
                }));

                // Convert to CSV
                const worksheet = XLSX.utils.json_to_sheet(csvData);
                const csv = XLSX.utils.sheet_to_csv(worksheet);

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `DVLA_Vehicle_Records_${timestamp}.csv`;
                
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                
                showSuccessModal('Export Successful', `${recordsToExport.length} records exported to ${filename}`);

            } catch (error) {
                console.error('CSV export error:', error);
                alert('Error exporting to CSV: ' + error.message);
            }
        }

        async function testConnection() {
            try {
                console.log('Testing API connection...');
                const response = await fetch('http://localhost/VIR/backend/api/test_connection.php');
                const result = await response.json();

                console.log('Test API Response:', result);

                if (result.status === 'success') {
                    alert(`API Connection Successful!\nTotal Records: ${result.total_records}\nAvailable Fields: ${result.available_fields.join(', ')}`);
                } else {
                    alert(`API Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Test API Error:', error);
                alert(`Connection Error: ${error.message}`);
            }
        }

        // Helper function to get status class
        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'active':
                    return 'bg-green-100 text-green-800';
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'expired':
                    return 'bg-red-100 text-red-800';
                case 'inactive':
                    return 'bg-gray-100 text-gray-800';
                default:
                    return 'bg-green-100 text-green-800';
            }
        }

        // Modal functions
        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('show');
            // Restore body scroll
            document.body.style.overflow = '';
        }

        function showSuccessModal(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('show');
        }



        // Populate edit form with record data
        function populateEditForm(record) {
            console.log('Populating edit form with record:', record);
            
            // Set record ID
            document.getElementById('edit_record_id').value = record.id;
            
            // Owner information
            document.getElementById('edit_owner_full_name').value = record.owner_full_name || '';
            document.getElementById('edit_owner_contact').value = record.owner_contact || '';
            document.getElementById('edit_owner_email').value = record.owner_email || '';
            document.getElementById('edit_owner_tin').value = record.owner_tin || '';
            document.getElementById('edit_owner_postal_address').value = record.owner_postal_address || '';
            document.getElementById('edit_owner_residential_address').value = record.owner_residential_address || '';
            
            // Vehicle information
            document.getElementById('edit_registration_number').value = record.vehicle_number || record.registration_number || '';
            document.getElementById('edit_vehicle_make').value = record.vehicle_make || '';
            document.getElementById('edit_model_name').value = record.model_name || '';
            document.getElementById('edit_year_of_manufacture').value = record.year_of_manufacture || '';
            document.getElementById('edit_chassis_number').value = record.chassis_number || '';
            document.getElementById('edit_engine_number').value = record.engine_number || '';
            document.getElementById('edit_body_type').value = record.body_type || '';
            document.getElementById('edit_color').value = record.color || '';
            document.getElementById('edit_fuel_type').value = record.fuel_type || '';
            document.getElementById('edit_vehicle_use').value = record.vehicle_use || '';
            document.getElementById('edit_cubic_capacity').value = record.cubic_capacity || '';
            document.getElementById('edit_number_of_cylinders').value = record.number_of_cylinders || record.cylinders || '';
            document.getElementById('edit_declaration_number').value = record.declaration_number || '';
            document.getElementById('edit_remarks').value = record.remarks || '';
        }

        // Close edit modal
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.remove('show');
            // Restore body scroll
            document.body.style.overflow = '';
            
            // Reset form
            document.getElementById('editVehicleForm').reset();
        }



        // Certificate generation functions
        let currentCertificateRecord = null;

        function showCertificateModal(record) {
            console.log('Showing certificate modal for record:', record);
            currentCertificateRecord = record;
            
            // Set default values
            const today = new Date().toISOString().split('T')[0];
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            const validUntil = nextYear.toISOString().split('T')[0];
            
            document.getElementById('certificateIssueDate').value = today;
            document.getElementById('certificateValidUntil').value = validUntil;
            
            // Generate initial preview
            previewCertificate();
            
            // Show modal
            const modal = document.getElementById('certificateModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeCertificateModal() {
            const modal = document.getElementById('certificateModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            currentCertificateRecord = null;
        }

        function previewCertificate() {
            if (!currentCertificateRecord) return;
            
            const certificateType = document.getElementById('certificateType').value;
            const issueDate = document.getElementById('certificateIssueDate').value;
            const validUntil = document.getElementById('certificateValidUntil').value;
            const issuingOfficer = document.getElementById('issuingOfficer').value;
            
            const certificateHtml = generateCertificateHTML(currentCertificateRecord, {
                type: certificateType,
                issueDate: issueDate,
                validUntil: validUntil,
                officer: issuingOfficer
            });
            
            document.getElementById('certificatePreview').innerHTML = certificateHtml;
        }

        function generateCertificateHTML(record, options) {
            const certificateNumber = `DVLA-${record.id}-${new Date().getFullYear()}`;
            const formattedIssueDate = formatDate(options.issueDate);
            const formattedValidUntil = formatDate(options.validUntil);
            
            let certificateTitle = '';
            let certificateDescription = '';
            
            switch (options.type) {
                case 'registration':
                    certificateTitle = 'VEHICLE REGISTRATION CERTIFICATE';
                    certificateDescription = 'This is to certify that the vehicle described below has been duly registered with the Driver and Vehicle Licensing Authority (DVLA).';
                    break;
                case 'ownership':
                    certificateTitle = 'CERTIFICATE OF OWNERSHIP';
                    certificateDescription = 'This is to certify that the person named below is the lawful owner of the vehicle described herein.';
                    break;
                case 'roadworthy':
                    certificateTitle = 'ROADWORTHY CERTIFICATE';
                    certificateDescription = 'This is to certify that the vehicle described below has been inspected and found to be roadworthy and safe for operation.';
                    break;
            }
            
            return `
                <div class="certificate-container" style="font-family: 'Times New Roman', serif; line-height: 1.6; color: #333;">
                    <!-- Header -->
                    <div style="text-align: center; border-bottom: 3px solid #2d5a27; padding-bottom: 20px; margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                            <div style="width: 80px; height: 80px; background: #2d5a27; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px;">
                                <span style="color: white; font-size: 24px; font-weight: bold;">DVLA</span>
                            </div>
                            <div>
                                <h1 style="margin: 0; font-size: 28px; font-weight: bold; color: #2d5a27;">DRIVER AND VEHICLE LICENSING AUTHORITY</h1>
                                <p style="margin: 5px 0 0 0; font-size: 16px; color: #666;">Republic of Ghana</p>
                            </div>
                        </div>
                        <h2 style="margin: 20px 0 0 0; font-size: 24px; font-weight: bold; color: #2d5a27; letter-spacing: 2px;">${certificateTitle}</h2>
                    </div>

                    <!-- Certificate Number and Date -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px;">
                        <div><strong>Certificate No:</strong> ${certificateNumber}</div>
                        <div><strong>Issue Date:</strong> ${formattedIssueDate}</div>
                        <div><strong>Valid Until:</strong> ${formattedValidUntil}</div>
                    </div>

                    <!-- Description -->
                    <p style="text-align: center; font-size: 16px; margin-bottom: 30px; font-style: italic; color: #555;">
                        ${certificateDescription}
                    </p>

                    <!-- Vehicle Information -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: #f0f8f0; padding: 10px; margin: 0 0 15px 0; font-size: 18px; color: #2d5a27; border-left: 4px solid #2d5a27;">VEHICLE INFORMATION</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                            <div><strong>Registration Number:</strong> ${record.vehicle_number || record.registration_number || 'N/A'}</div>
                            <div><strong>Make:</strong> ${record.vehicle_make || 'N/A'}</div>
                            <div><strong>Model:</strong> ${record.model_name || 'N/A'}</div>
                            <div><strong>Year of Manufacture:</strong> ${record.year_of_manufacture || 'N/A'}</div>
                            <div><strong>Chassis Number:</strong> ${record.chassis_number || 'N/A'}</div>
                            <div><strong>Engine Number:</strong> ${record.engine_number || 'N/A'}</div>
                            <div><strong>Body Type:</strong> ${record.body_type || 'N/A'}</div>
                            <div><strong>Color:</strong> ${record.color || 'N/A'}</div>
                            <div><strong>Fuel Type:</strong> ${record.fuel_type || 'N/A'}</div>
                            <div><strong>Vehicle Use:</strong> ${record.vehicle_use || 'N/A'}</div>
                            <div><strong>Cubic Capacity:</strong> ${record.cubic_capacity || 'N/A'} CC</div>
                            <div><strong>Number of Cylinders:</strong> ${record.number_of_cylinders || record.cylinders || 'N/A'}</div>
                        </div>
                    </div>

                    <!-- Owner Information -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: #f0f8f0; padding: 10px; margin: 0 0 15px 0; font-size: 18px; color: #2d5a27; border-left: 4px solid #2d5a27;">OWNER INFORMATION</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                            <div><strong>Full Name:</strong> ${record.owner_full_name || 'N/A'}</div>
                            <div><strong>Contact Number:</strong> ${record.owner_contact || 'N/A'}</div>
                            <div><strong>Email Address:</strong> ${record.owner_email || 'N/A'}</div>
                            <div><strong>TIN Number:</strong> ${record.owner_tin || 'N/A'}</div>
                            <div style="grid-column: 1 / -1;"><strong>Postal Address:</strong> ${record.owner_postal_address || 'N/A'}</div>
                            <div style="grid-column: 1 / -1;"><strong>Residential Address:</strong> ${record.owner_residential_address || 'N/A'}</div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 50px; display: flex; justify-content: space-between; align-items: end;">
                        <div style="text-align: center; flex: 1;">
                            <div style="border-top: 2px solid #333; width: 200px; margin: 0 auto 10px auto;"></div>
                            <p style="margin: 0; font-size: 14px;"><strong>Issuing Officer</strong></p>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">${options.officer || 'DVLA Official'}</p>
                        </div>
                        <div style="text-align: center; flex: 1;">
                            <div style="width: 100px; height: 100px; border: 2px solid #2d5a27; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; background: #f9f9f9;">
                                <span style="font-size: 12px; color: #666;">OFFICIAL SEAL</span>
                            </div>
                        </div>
                        <div style="text-align: center; flex: 1;">
                            <div style="border-top: 2px solid #333; width: 200px; margin: 0 auto 10px auto;"></div>
                            <p style="margin: 0; font-size: 14px;"><strong>Director General</strong></p>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">Driver and Vehicle Licensing Authority</p>
                        </div>
                    </div>

                    <!-- Disclaimer -->
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #666; text-align: center;">
                        <p style="margin: 0;">This certificate is issued under the authority of the Driver and Vehicle Licensing Authority Act.</p>
                        <p style="margin: 5px 0 0 0;">Any alteration or forgery of this document is a criminal offense punishable by law.</p>
                    </div>
                </div>
            `;
        }

        function downloadCertificate() {
            if (!currentCertificateRecord) {
                alert('No record selected for certificate generation');
                return;
            }

            // Show loading state
            const downloadBtn = document.querySelector('#certificateModal button:last-child');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<span class="material-icons mr-2 animate-spin">refresh</span>Generating...';
            downloadBtn.disabled = true;

            try {
                // Get certificate content
                const certificateContent = document.getElementById('certificatePreview').innerHTML;
                const certificateType = document.getElementById('certificateType').value;
                const vehicleNumber = currentCertificateRecord.vehicle_number || currentCertificateRecord.registration_number || 'Unknown';
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Vehicle ${certificateType.charAt(0).toUpperCase() + certificateType.slice(1)} Certificate - ${vehicleNumber}</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                font-family: 'Times New Roman', serif; 
                                background: white;
                            }
                            @media print {
                                body { margin: 0; padding: 15px; }
                                .no-print { display: none; }
                            }
                            .print-controls {
                                text-align: center;
                                margin-bottom: 20px;
                                padding: 10px;
                                background: #f0f0f0;
                                border-radius: 5px;
                            }
                            .print-controls button {
                                margin: 0 10px;
                                padding: 10px 20px;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            }
                            .print-btn {
                                background: #2d5a27;
                                color: white;
                            }
                            .close-btn {
                                background: #666;
                                color: white;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-controls no-print">
                            <button class="print-btn" onclick="window.print()">ð¨ï¸ Print Certificate</button>
                            <button class="close-btn" onclick="window.close()">â Close</button>
                        </div>
                        ${certificateContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();

                // Log the activity
                console.log('Certificate generated for vehicle:', vehicleNumber);
                
                // Show success message
                setTimeout(() => {
                    showSuccessModal('Certificate Generated', `${certificateType.charAt(0).toUpperCase() + certificateType.slice(1)} certificate has been generated successfully for vehicle ${vehicleNumber}.`);
                    closeCertificateModal();
                }, 1000);

            } catch (error) {
                console.error('Error generating certificate:', error);
                alert('Error generating certificate: ' + error.message);
            } finally {
                // Reset button state
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }, 1000);
            }
        }



        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('show');
        }

        function showErrorModal(title, message) {
            // Create error modal if it doesn't exist
            let errorModal = document.getElementById('errorModal');
            if (!errorModal) {
                errorModal = document.createElement('div');
                errorModal.id = 'errorModal';
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <span class="material-icons text-red-600">error</span>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2" id="errorTitle">Error</h3>
                            <p class="text-sm text-gray-500 mb-4" id="errorMessage">An error occurred</p>
                            <button onclick="closeErrorModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                OK
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
            }

            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            errorModal.classList.remove('hidden');
        }

        function closeErrorModal() {
            const errorModal = document.getElementById('errorModal');
            if (errorModal) {
                errorModal.classList.add('hidden');
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showTable() {
            document.getElementById('tableContainer').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function showEmptyState() {
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function hideEmptyState() {
            document.getElementById('emptyState').classList.add('hidden');
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'login.html';
            }
        }

        // Vehicle dropdown toggle
        function toggleVehicleDropdown() {
            const dropdown = document.getElementById('vehicleDropdown');
            const icon = document.getElementById('vehicleDropdownIcon');

            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                icon.textContent = 'expand_less';
            } else {
                dropdown.classList.add('hidden');
                icon.textContent = 'expand_more';
            }
        }

        // Certificate options change handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for certificate options
            const certificateType = document.getElementById('certificateType');
            const issueDate = document.getElementById('certificateIssueDate');
            const validUntil = document.getElementById('certificateValidUntil');
            const issuingOfficer = document.getElementById('issuingOfficer');
            
            if (certificateType) {
                certificateType.addEventListener('change', previewCertificate);
            }
            if (issueDate) {
                issueDate.addEventListener('change', previewCertificate);
            }
            if (validUntil) {
                validUntil.addEventListener('change', previewCertificate);
            }
            if (issuingOfficer) {
                issuingOfficer.addEventListener('change', previewCertificate);
            }
        });

        // Edit form submission handler
        document.getElementById('editVehicleForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            console.log('Edit form submitted');
            
            // Get form data
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            console.log('Edit form data:', data);
            
            try {
                // Show loading state
                const submitButton = event.target.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<span class="material-icons mr-2 animate-spin">refresh</span>Updating...';
                submitButton.disabled = true;

                // Call the update API endpoint
                const response = await fetch('http://localhost/VIR/backend/api/vehicle_registration.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        showSuccessModal('Update Successful', 'Vehicle registration has been updated successfully.');
                        closeEditModal();
                        
                        // Update the record in allRecords array
                        const recordIndex = allRecords.findIndex(r => r.id == data.record_id);
                        if (recordIndex !== -1) {
                            allRecords[recordIndex] = { ...allRecords[recordIndex], ...data };
                        }
                        
                        // Refresh the display
                        displayRecords();
                    } else {
                        throw new Error(result.message || 'Update failed');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Update failed. Please try again.');
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Error updating record: ' + error.message);
            } finally {
                // Reset button state
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.innerHTML = '<span class="material-icons mr-2">save</span>Update Record';
                submitButton.disabled = false;
            }
        });

        // Modal event listeners
        document.addEventListener('click', function(event) {
            const viewModal = document.getElementById('viewModal');
            const editModal = document.getElementById('editModal');
            const certificateModal = document.getElementById('certificateModal');
            const successModal = document.getElementById('successModal');
            
            if (event.target === viewModal) {
                closeViewModal();
            }
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === certificateModal) {
                closeCertificateModal();
            }
            if (event.target === successModal) {
                closeSuccessModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const viewModal = document.getElementById('viewModal');
                const editModal = document.getElementById('editModal');
                const certificateModal = document.getElementById('certificateModal');
                
                if (viewModal.classList.contains('show')) {
                    closeViewModal();
                }
                if (editModal.classList.contains('show')) {
                    closeEditModal();
                }
                if (certificateModal.classList.contains('show')) {
                    closeCertificateModal();
                }
            }
        });

        // Vehicle dropdown toggle function
        function toggleVehicleDropdown() {
            const dropdown = document.getElementById('vehicleDropdown');
            const icon = document.getElementById('vehicleDropdownIcon');

            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                icon.textContent = 'expand_less';
            } else {
                dropdown.classList.add('hidden');
                icon.textContent = 'expand_more';
            }
        }

        // Ownership dropdown toggle function
        function toggleOwnershipDropdown() {
            const dropdown = document.getElementById('ownershipDropdown');
            const icon = document.getElementById('ownershipDropdownIcon');

            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                icon.textContent = 'expand_less';
            } else {
                dropdown.classList.add('hidden');
                icon.textContent = 'expand_more';
            }
        }
    </script>
</body>

</html>